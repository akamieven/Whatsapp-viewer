<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Analyzer Pro - Enhanced UI</title>
    <style>
        :root {
            --bg: #e5ddd5; --header: #075e54; --toolbar: #f0f2f5;
            --msg-sent: #dcf8c6; --msg-received: #ffffff; --text: #000; --meta: #888;
            --accent: #128c7e;
        }
        .dark-mode {
            --bg: #0b141a; --header: #202c33; --toolbar: #111b21;
            --msg-sent: #005c4b; --msg-received: #202c33; --text: #e9edef; --meta: #8696a0;
            --accent: #00a884;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--text); transition: 0.3s; overflow: hidden; }
        
        header { background: var(--header); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-wrapper { background: var(--toolbar); border-bottom: 1px solid #ccc; z-index: 999; }
        .stats-header { padding: 10px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.03); font-weight: bold; }
        .stats-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; display: flex; flex-wrap: wrap; gap: 10px; padding: 0 20px; }
        .stats-content.open { max-height: 300px; padding: 15px 20px; overflow-y: auto; }
        
        .stat-card { background: var(--msg-received); padding: 10px 18px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; min-width: 140px; }
        .stat-card .name { color: var(--accent); font-weight: bold; font-size: 14px; }
        .stat-card .count { font-size: 18px; margin-top: 4px; }

        .toolbar { background: var(--toolbar); padding: 12px 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; border-bottom: 1px solid #ddd; }
        
        #chatContainer { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); scroll-behavior: smooth; }
        .dark-mode #chatContainer { background-blend-mode: overlay; background-color: #0b141a; }

        .message { max-width: 85%; padding: 10px 14px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); position: relative; font-size: 15px; }
        .highlight-msg { outline: 3px solid #ffeb3b; outline-offset: 2px; }
        .sent { align-self: flex-end; background: var(--msg-sent); border-top-left-radius: 0; }
        .received { align-self: flex-start; background: var(--msg-received); border-top-right-radius: 0; }
        .meta { font-size: 11px; color: var(--meta); display: block; margin-top: 6px; text-align: left; }

        .search-nav { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 25px; border: 1px solid #ccc; }
        .search-count { font-size: 13px; font-weight: bold; color: var(--accent); }

        .bottom-nav { position: sticky; bottom: 0; background: var(--toolbar); padding: 12px; display: flex; justify-content: center; align-items: center; gap: 30px; border-top: 1px solid #ddd; }
        button { padding: 8px 20px; border-radius: 20px; border: none; background: var(--header); color: white; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #bbb; cursor: not-allowed; transform: none; }
        
        input { border-radius: 18px; border: 1px solid #ccc; padding: 6px 15px; background: var(--msg-received); color: var(--text); }
    </style>
</head>
<body>

<header>
    <span>WhatsApp Pro Analyzer</span>
    <button onclick="document.body.classList.toggle('dark-mode')" style="background: rgba(255,255,255,0.2);">ğŸŒ™ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¤ÙŠØ©</button>
</header>

<div class="stats-wrapper" id="statsWrapper" style="display:none;">
    <div class="stats-header" onclick="document.getElementById('statsContent').classList.toggle('open')">
        <span id="summaryText">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Øª (Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ³ÙŠØ¹) ğŸ“Š</span>
        <span>â–¼</span>
    </div>
    <div class="stats-content" id="statsContent">
        </div>
</div>

<div class="toolbar">
    <input type="file" id="fileInput" accept=".txt">
    <div class="search-nav">
        <input type="text" id="searchBar" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„..." disabled>
        <span class="search-count" id="searchCount">0 / 0</span>
        <button onclick="navigateSearch(-1)" id="prevSearch" disabled style="padding:2px 10px">â†‘</button>
        <button onclick="navigateSearch(1)" id="nextSearch" disabled style="padding:2px 10px">â†“</button>
    </div>
    <input type="date" id="datePicker" disabled>
</div>

<div id="chatContainer"></div>

<div class="bottom-nav">
    <button onclick="changePage(-1)" id="prevBtn" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <b id="pageInfo" style="min-width: 120px; text-align: center;">ØµÙØ­Ø© 0</b>
    <button onclick="changePage(1)" id="nextBtn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
</div>

<script>
    let allMessages = [];
    let searchResultsIndexes = [];
    let currentSearchMatch = -1;
    let currentPage = 0;
    const pageSize = 100;

    const fileInput = document.getElementById('fileInput');
    const chatContainer = document.getElementById('chatContainer');
    const searchBar = document.getElementById('searchBar');

    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.split(/\n(?=\d{1,2}\/\d{1,2}\/\d{2,4})/);
            allMessages = lines.map((line, index) => {
                const match = line.match(/(\d{1,2}\/\d{1,2}\/\d{2,4}),\s(\d{1,2}:\d{2}\s[APM]+)\s-\s([^:]+):\s([\s\S]+)/);
                if (match) {
                    return { id: index, date: match[1], time: match[2], sender: match[3].trim(), text: match[4].trim(), iso: convertToISO(match[1]) };
                }
                return null;
            }).filter(m => m !== null);
            
            calculateStats();
            enableUI();
            renderPage(0);
        };
        reader.readAsText(file);
    };

    function calculateStats() {
        document.getElementById('statsWrapper').style.display = 'block';
        const statsContent = document.getElementById('statsContent');
        const summaryText = document.getElementById('summaryText');
        
        const counts = {};
        allMessages.forEach(m => counts[m.sender] = (counts[m.sender] || 0) + 1);

        summaryText.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${allMessages.length.toLocaleString()} | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†: ${Object.keys(counts).length}`;

        statsContent.innerHTML = '';
        Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `<span class="name">${name}</span><span class="count">${count.toLocaleString()}</span>`;
            statsContent.appendChild(card);
        });
    }

    function renderPage(page, highlightId = null) {
        currentPage = page;
        chatContainer.innerHTML = '';
        const start = page * pageSize;
        const toDisplay = allMessages.slice(start, start + pageSize);
        
        toDisplay.forEach(m => {
            const div = document.createElement('div');
            div.className = `message ${m.sender === allMessages[0].sender ? 'received' : 'sent'} ${m.id === highlightId ? 'highlight-msg' : ''}`;
            div.id = `msg-${m.id}`;
            div.innerHTML = `<b style="color:var(--accent); font-size:13px">${m.sender}</b><br>${m.text.replace(/\n/g,'<br>')}<span class="meta">${m.date} | ${m.time}</span>`;
            chatContainer.appendChild(div);
        });
        
        document.getElementById('pageInfo').innerText = `ØµÙØ­Ø© ${currentPage + 1} Ù…Ù† ${Math.ceil(allMessages.length / pageSize)}`;
        updateNavButtons();

        if (highlightId) {
            setTimeout(() => {
                const el = document.getElementById(`msg-${highlightId}`);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 200);
        }
    }

    function navigateSearch(direction) {
        if (searchResultsIndexes.length === 0) return;
        currentSearchMatch = (currentSearchMatch + direction + searchResultsIndexes.length) % searchResultsIndexes.length;
        const targetId = searchResultsIndexes[currentSearchMatch];
        const targetPage = Math.floor(allMessages.findIndex(m => m.id === targetId) / pageSize);
        document.getElementById('searchCount').innerText = `${currentSearchMatch + 1} / ${searchResultsIndexes.length}`;
        renderPage(targetPage, targetId);
    }

    searchBar.oninput = function() {
        const q = this.value.toLowerCase();
        if (q.length < 2) { 
            searchResultsIndexes = []; 
            document.getElementById('searchCount').innerText = "0 / 0"; 
            return; 
        }
        searchResultsIndexes = allMessages.filter(m => m.text.toLowerCase().includes(q)).map(m => m.id);
        document.getElementById('searchCount').innerText = `0 / ${searchResultsIndexes.length}`;
        currentSearchMatch = -1;
        document.getElementById('nextSearch').disabled = document.getElementById('prevSearch').disabled = searchResultsIndexes.length === 0;
    };

    function changePage(step) { renderPage(currentPage + step); }
    function updateNavButtons() {
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = (currentPage + 1) * pageSize >= allMessages.length;
    }
    function enableUI() {
        searchBar.disabled = false;
        document.getElementById('datePicker').disabled = false;
    }
    function convertToISO(d) {
        const p = d.split('/');
        return `${p[2].length===2?'20'+p[2]:p[2]}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`;
    }
    document.getElementById('datePicker').onchange = function() {
        const idx = allMessages.findIndex(m => m.iso === this.value);
        if (idx !== -1) renderPage(Math.floor(idx / pageSize), allMessages[idx].id);
    };
</script>
</body>
</html>
