<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Analyzer Pro</title>
    <style>
        :root {
            --bg: #e5ddd5; --header: #075e54; --toolbar: #f0f2f5;
            --msg-sent: #dcf8c6; --msg-received: #ffffff; --text: #000; --meta: #888;
            --accent: #128c7e; --highlight: #ffeb3b;
        }
        .dark-mode {
            --bg: #0b141a; --header: #202c33; --toolbar: #111b21;
            --msg-sent: #005c4b; --msg-received: #202c33; --text: #e9edef; --meta: #8696a0;
            --accent: #00a884; --highlight: #604e00;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--text); transition: 0.3s; }
        
        header { background: var(--header); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .toolbar { background: var(--toolbar); padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); }
        
        #chatContainer { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-attachment: fixed; }
        .dark-mode #chatContainer { background-blend-mode: multiply; background-color: #0b141a; }

        .message { max-width: 75%; padding: 8px 12px; border-radius: 8px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; font-size: 14.5px; line-height: 1.5; word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--msg-sent); border-top-left-radius: 8px; }
        .received { align-self: flex-start; background: var(--msg-received); border-top-right-radius: 8px; }
        
        .sender-name { font-weight: bold; font-size: 12px; color: var(--accent); margin-bottom: 2px; display: block; }
        .meta { font-size: 10px; color: var(--meta); margin-top: 4px; display: flex; justify-content: flex-end; gap: 5px; }
        
        .highlight-text { background-color: var(--highlight); font-weight: bold; border-radius: 2px; }
        .highlight-msg { ring: 3px solid var(--accent); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(18, 140, 126, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(18, 140, 126, 0); } 100% { box-shadow: 0 0 0 0 rgba(18, 140, 126, 0); } }

        .stats-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 15px; background: var(--toolbar); display: none; }
        .stat-card { background: var(--msg-received); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(0,0,0,0.05); }

        .omitted { color: #888; font-style: italic; font-size: 13px; }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑŸáŸàÿßÿ™ŸÅ */
        @media (max-width: 600px) { .message { max-width: 90%; } .toolbar { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <strong>WhatsApp Viewer</strong>
        <span id="fileStatus" style="font-size: 12px; opacity: 0.8;"></span>
    </div>
    <button onclick="document.body.classList.toggle('dark-mode')">üåì Ÿàÿ∂ÿπ ÿßŸÑÿ±ÿ§Ÿäÿ©</button>
</header>

<div id="statsPanel" class="stats-content"></div>

<div class="toolbar">
    <input type="file" id="fileInput" accept=".txt">
    <input type="text" id="searchBar" placeholder="ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©..." disabled>
    <div style="display:flex; align-items:center; gap:5px">
        <button onclick="navigateSearch(-1)" id="prevSearch" disabled>‚Üë</button>
        <span id="searchCount">0/0</span>
        <button onclick="navigateSearch(1)" id="nextSearch" disabled>‚Üì</button>
    </div>
    <input type="date" id="datePicker" disabled>
</div>

<div id="chatContainer"></div>

<div class="bottom-nav" style="background: var(--toolbar); padding: 10px; display: flex; justify-content: center; align-items: center; gap: 15px; border-top: 1px solid #ddd;">
    <button onclick="changePage(-1)" id="prevBtn" disabled>ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
    <span id="pageInfo">ÿµŸÅÿ≠ÿ© 0 / 0</span>
    <button onclick="changePage(1)" id="nextBtn" disabled>ÿßŸÑÿ™ÿßŸÑŸä</button>
</div>

<script>
    let allMessages = [];
    let searchResults = [];
    let currentMatchIdx = -1;
    let currentPage = 0;
    const pageSize = 150;

    // ÿ™ÿ≠ÿ≥ŸäŸÜ Regex ŸÑŸäÿØÿπŸÖ ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿ£ŸÉÿ´ÿ± (ÿ®ŸÖÿß ŸÅŸäŸáÿß AM/PM ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä ŸàÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä)
    const msgRegex = /^(\d{1,2}\/\d{1,2}\/\d{2,4}),\s(\d{1,2}:\d{2}(?:\s?[APMapmÿµŸÇ]+)?)\s-\s([^:]+):\s([\s\S]+)/;

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.split(/\n(?=\d{1,2}\/\d{1,2}\/\d{2,4})/);
            allMessages = lines.map((line, index) => {
                const match = line.match(msgRegex);
                if (match) {
                    return {
                        id: index,
                        date: match[1],
                        time: match[2],
                        sender: match[3].trim(),
                        text: match[4].trim(),
                        iso: convertToISO(match[1])
                    };
                }
                return null;
            }).filter(m => m !== null);

            if(allMessages.length > 0) {
                document.getElementById('fileStatus').innerText = `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${allMessages.length} ÿ±ÿ≥ÿßŸÑÿ©`;
                showStats();
                enableUI();
                renderPage(0);
            } else {
                alert("ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ. ÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸá ŸÖŸÑŸÅ ŸÜÿµŸä ŸÖÿµÿØŸëÿ± ŸÖŸÜ Ÿàÿßÿ™ÿ≥ÿßÿ®.");
            }
        };
        reader.readAsText(file);
    };

    function renderPage(page, highlightId = null, searchTerm = "") {
        currentPage = page;
        const container = document.getElementById('chatContainer');
        container.innerHTML = '';
        
        const start = page * pageSize;
        const slice = allMessages.slice(start, start + pageSize);

        slice.forEach(m => {
            const isSent = m.sender === allMessages[0].sender;
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'} ${m.id === highlightId ? 'highlight-msg' : ''}`;
            div.id = `msg-${m.id}`;

            let content = m.text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // ÿ≠ŸÖÿßŸäÿ© XSS
                .replace(/\n/g, '<br>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>'); // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑

            if (searchTerm && searchTerm.length > 1) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                content = content.replace(regex, '<mark class="highlight-text">$1</mark>');
            }

            if(content.includes("&lt;Media omitted&gt;")) {
                content = `<span class="omitted">üì∑ Ÿàÿ≥ÿßÿ¶ÿ∑ ŸÖÿ±ŸÅŸÇÿ©</span>`;
            }

            div.innerHTML = `
                <span class="sender-name">${m.sender}</span>
                <div class="text">${content}</div>
                <div class="meta"><span>${m.time}</span> <span>${m.date}</span></div>
            `;
            container.appendChild(div);
        });

        document.getElementById('pageInfo').innerText = `ÿµŸÅÿ≠ÿ© ${currentPage + 1} ŸÖŸÜ ${Math.ceil(allMessages.length / pageSize)}`;
        updateButtons();
        if (highlightId) {
            document.getElementById(`msg-${highlightId}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function showStats() {
        const panel = document.getElementById('statsPanel');
        panel.style.display = 'grid';
        const counts = {};
        allMessages.forEach(m => counts[m.sender] = (counts[m.sender] || 0) + 1);
        
        panel.innerHTML = Object.entries(counts)
            .sort((a,b) => b[1] - a[1])
            .map(([name, count]) => `
                <div class="stat-card">
                    <div style="color:var(--accent); font-weight:bold; font-size:12px">${name}</div>
                    <div style="font-size:18px">${count.toLocaleString()}</div>
                </div>
            `).join('');
    }

    document.getElementById('searchBar').oninput = function() {
        const term = this.value.toLowerCase();
        if(term.length < 2) {
            searchResults = [];
            document.getElementById('searchCount').innerText = "0/0";
            return;
        }
        searchResults = allMessages.filter(m => m.text.toLowerCase().includes(term)).map(m => m.id);
        document.getElementById('searchCount').innerText = `0/${searchResults.length}`;
        currentMatchIdx = -1;
        document.getElementById('nextSearch').disabled = document.getElementById('prevSearch').disabled = searchResults.length === 0;
    };

    function navigateSearch(dir) {
        if(!searchResults.length) return;
        currentMatchIdx = (currentMatchIdx + dir + searchResults.length) % searchResults.length;
        const msgId = searchResults[currentMatchIdx];
        const page = Math.floor(allMessages.findIndex(m => m.id === msgId) / pageSize);
        document.getElementById('searchCount').innerText = `${currentMatchIdx + 1}/${searchResults.length}`;
        renderPage(page, msgId, document.getElementById('searchBar').value);
    }

    function convertToISO(d) {
        const p = d.split('/');
        if(p.length < 3) return "";
        let year = p[2].length === 2 ? "20" + p[2] : p[2];
        return `${year}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`;
    }

    function changePage(step) { renderPage(currentPage + step); }
    function updateButtons() {
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = (currentPage + 1) * pageSize >= allMessages.length;
    }
    function enableUI() {
        document.getElementById('searchBar').disabled = false;
        document.getElementById('datePicker').disabled = false;
    }
    document.getElementById('datePicker').onchange = function() {
        const idx = allMessages.findIndex(m => m.iso === this.value);
        if (idx !== -1) renderPage(Math.floor(idx / pageSize), allMessages[idx].id);
    };
</script>
</body>
</html>
